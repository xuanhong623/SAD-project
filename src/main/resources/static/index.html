<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>飛常順 MVP 主頁</title>
    <style>
        :root {
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto;
        }

        body {
            margin: 0;
            background: #0b1220;
            color: #e5e7eb;
        }

        .wrap {
            max-width: 900px;
            margin: 40px auto;
            padding: 0 16px;
        }

        .card {
            background: #111827;
            border: 1px solid #1f2937;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .25);
        }

        h1 {
            margin: 0 0 12px;
            font-size: 24px;
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        input[type="number"] {
            background: #0f172a;
            border: 1px solid #374151;
            color: #e5e7eb;
            border-radius: 10px;
            padding: 10px 12px;
            width: 120px;
        }

        button {
            background: #2563eb;
            color: #fff;
            border: 0;
            border-radius: 10px;
            padding: 10px 14px;
            cursor: pointer;
        }

        button:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        .status {
            margin-top: 12px;
            font-size: 14px;
            color: #9ca3af;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        th,
        td {
            text-align: left;
            padding: 12px 10px;
            border-bottom: 1px solid #1f2937;
        }

        th {
            color: #9ca3af;
            font-weight: 600;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            border: 1px solid #374151;
            background: #0f172a;
        }

        .ok {
            color: #34d399;
        }

        .warn {
            color: #f59e0b;
        }

        .err {
            color: #f87171;
        }

        .banner {
            margin-top: 12px;
            padding: 10px 12px;
            border-radius: 10px;
            background: #0f172a;
            border: 1px dashed #374151;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 12px;
        }

        .k {
            font-size: 12px;
            color: #9ca3af;
        }

        .v {
            font-size: 16px;
        }

        @media (max-width:700px) {
            .grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="card">
            <h1>飛常不順｜主頁</h1>
            <div class="row">
                <label for="flightId">Flight ID</label>
                <input id="flightId" type="number" value="1" min="1" />
                <button id="refreshBtn">立即更新</button>
                <span class="badge" id="autoBadge">自動更新中</span>
            </div>

            <div class="banner" id="banner">
                系統會每 5 秒檢查備援方案。偵測到延誤後，這裡會顯示建議方案。
            </div>

            <div class="grid">
                <div>
                    <div class="k">航班狀態</div>
                    <div class="v" id="flightStatus">未知</div>
                </div>
                <div>
                    <div class="k">方案筆數</div>
                    <div class="v" id="planCount">0</div>
                </div>
                <div>
                    <div class="k">上次更新</div>
                    <div class="v" id="lastUpdated">—</div>
                </div>
            </div>

            <div class="status" id="statusText">等待資料…</div>

            <table id="plansTable" style="display:none;">
                <thead>
                    <tr>
                        <th>方案</th>
                        <th>預估抵達</th>
                        <th>費用</th>
                        <th>動作</th>
                    </tr>
                </thead>
                <tbody id="plansBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = ''; // 同網域部署，留空即可。若不同網域，設成 'http://localhost:8080'
        const POLL_MS = 5000;

        const el = {
            flightId: document.getElementById('flightId'),
            refreshBtn: document.getElementById('refreshBtn'),
            autoBadge: document.getElementById('autoBadge'),
            statusText: document.getElementById('statusText'),
            plansTable: document.getElementById('plansTable'),
            plansBody: document.getElementById('plansBody'),
            banner: document.getElementById('banner'),
            planCount: document.getElementById('planCount'),
            lastUpdated: document.getElementById('lastUpdated'),
            flightStatus: document.getElementById('flightStatus'),
        };

        let timer = null;
        let isFetching = false;

        function fmtTwd(n) { return new Intl.NumberFormat('zh-Hant', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(n); }
        function nowStr() { const d = new Date(); return d.toLocaleString('zh-Hant-TW'); }

        async function fetchPlans() {
            if (isFetching) return;
            isFetching = true;
            el.refreshBtn.disabled = true;
            const flightId = Number(el.flightId.value || 1);
            const url = `${API_BASE}/dashboard/plans/${flightId}`;

            try {
                el.statusText.textContent = '載入中…';
                const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                renderPlans(data);
                el.planCount.textContent = data.length;
                el.lastUpdated.textContent = nowStr();

                // 簡單推斷：有方案即視為延誤已觸發
                el.flightStatus.innerHTML = data.length > 0
                    ? '<span class="ok">延誤已偵測，已產生方案</span>'
                    : '<span class="warn">未偵測到延誤</span>';

                el.statusText.textContent = data.length > 0 ? '已更新' : '尚無方案，等待系統判定延誤…';
                el.banner.style.display = data.length > 0 ? 'none' : 'block';
            } catch (e) {
                el.statusText.innerHTML = `<span class="err">讀取失敗：${e.message}</span>`;
                el.flightStatus.innerHTML = '<span class="err">未知</span>';
                el.plansTable.style.display = 'none';
            } finally {
                el.refreshBtn.disabled = false;
                isFetching = false;
            }
        }

        function renderPlans(list) {
            if (!Array.isArray(list) || list.length === 0) {
                el.plansTable.style.display = 'none';
                el.plansBody.innerHTML = '';
                return;
            }
            el.plansTable.style.display = 'table';
            el.plansBody.innerHTML = list.map(p => `
        <tr>
          <td>${labelPlanType(p.planType)}</td>
          <td>${escapeHtml(p.arrivalTime || '')}</td>
          <td>${fmtTwd(p.cost || 0)}</td>
          <td><button onclick="selectPlan('${p.planType}')">選擇</button></td>
        </tr>
      `).join('');
        }

        function labelPlanType(t) {
            if (t === 'flight') return '改搭航班';
            if (t === 'rail') return '改搭鐵路';
            if (t === 'hotel') return '住宿＋隔日飛';
            return t || '未知';
        }

        function escapeHtml(s) {
            return String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", "&#039;");
        }

        // Demo 動作：僅顯示選擇結果，不呼叫後端下單
        window.selectPlan = function (type) {
            alert(`已選擇方案：${labelPlanType(type)}（Demo）`);
        }

        function startAuto() {
            stopAuto();
            timer = setInterval(fetchPlans, POLL_MS);
            el.autoBadge.textContent = '自動更新中';
        }
        function stopAuto() {
            if (timer) clearInterval(timer);
            timer = null;
            el.autoBadge.textContent = '自動更新關閉';
        }

        // 綁定事件
        el.refreshBtn.addEventListener('click', fetchPlans);
        el.flightId.addEventListener('change', fetchPlans);
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) stopAuto(); else startAuto();
        });

        // 啟動
        fetchPlans();
        startAuto();
    </script>
</body>

</html>